apiVersion: v1
kind: ConfigMap
metadata:
  name: pgbouncer-config
  namespace: velure-db
  labels:
    app: pgbouncer
data:
  pgbouncer.ini: |
    ;; PgBouncer Configuration for Velure
    ;; Docs: https://www.pgbouncer.org/config.html

    [databases]
    ; Database connections
    ; Format: dbname = host=HOST port=PORT dbname=DBNAME
    velure_auth = host=$(DB_HOST) port=5432 dbname=velure_auth
    velure_orders = host=$(DB_HOST) port=5432 dbname=velure_orders

    ; Fallback database for admin commands
    * = host=$(DB_HOST) port=5432

    [pgbouncer]
    ;;;
    ;;; Administrative settings
    ;;;

    ; Connection settings
    listen_addr = 0.0.0.0
    listen_port = 5432

    ; Unix socket is also used for local connections
    unix_socket_dir = /tmp
    unix_socket_mode = 0777

    ;;;
    ;;; Authentication settings
    ;;;

    auth_type = md5
    auth_file = /etc/pgbouncer/userlist.txt

    ; Query to load user password hashes
    ; auth_query = SELECT usename, passwd FROM pg_shadow WHERE usename=$1

    ;;;
    ;;; Connection Pooling Settings (CRITICAL FOR PERFORMANCE)
    ;;;

    ; When server connection is released back to pool:
    ;   session     - after client disconnects (default)
    ;   transaction - after transaction finishes (recommended for microservices)
    ;   statement   - after statement finishes (aggressive, breaks some features)
    pool_mode = transaction

    ; Maximum number of client connections allowed
    ; Each K8s pod can open up to this many connections
    max_client_conn = 1000

    ; Default pool size (connections to actual PostgreSQL)
    ; This is PER DATABASE (velure_auth + velure_orders = 2 Ã— 25 = 50 total)
    default_pool_size = 25

    ; Minimum pool size (keep at least this many connections open)
    min_pool_size = 5

    ; Reserve pool - additional connections if default_pool_size is exhausted
    reserve_pool_size = 5

    ; If a client has been waiting for longer than this, use reserve pool
    reserve_pool_timeout = 3

    ;;;
    ;;; Connection Limits
    ;;;

    ; Maximum connections per user+database pair
    max_db_connections = 50

    ; Maximum connections per user
    max_user_connections = 100

    ;;;
    ;;; Connection Timeouts
    ;;;

    ; Close server connection if idle longer than this (seconds)
    server_idle_timeout = 600

    ; Maximum server connection age (seconds)
    ; Forces connection recycling
    server_lifetime = 3600

    ; How long to wait when connecting to server (seconds)
    server_connect_timeout = 15

    ; Client connection timeout (seconds)
    client_idle_timeout = 0

    ; How long to wait for server to accept query (seconds)
    query_timeout = 0

    ; How long clients can wait for server connection (seconds)
    ; 0 = unlimited
    query_wait_timeout = 120

    ;;;
    ;;; Logging
    ;;;

    ; Log level: debug, info, warning, error
    log_level = info

    ; Log all connections
    log_connections = 1

    ; Log disconnections with reasons
    log_disconnections = 1

    ; Log pooler errors
    log_pooler_errors = 1

    ;;;
    ;;; Console access control
    ;;;

    ; Comma-separated list of users who are allowed to use the admin console
    admin_users = postgres

    ; Comma-separated list of users who can use SHOW and other read-only queries
    stats_users = postgres

    ;;;
    ;;; Dangerous Settings (DO NOT CHANGE unless you know what you're doing)
    ;;;

    ; Disable SSL for internal K8s communication (RDS handles TLS)
    # server_tls_sslmode = prefer

    ; Disable client TLS (services connect via internal K8s network)
    # client_tls_sslmode = disable

    ; Application name to send to server
    application_name_add_host = 1

    ; Ignore startup parameters
    ignore_startup_parameters = extra_float_digits

    ; Server reset query (transaction mode only)
    ; server_reset_query = DISCARD ALL

    ; Server check query (must return quickly)
    server_check_query = SELECT 1

    ; Server check delay (seconds)
    server_check_delay = 30

  userlist.txt: |
    ; PgBouncer user list
    ; Format: "username" "password_hash"
    ; Generate hash: echo -n "passwordUSERNAME" | md5sum
    ; Example for user "postgres" with password "mypass":
    ;   echo -n "mypasspostgres" | md5sum
    ;   Result: md5XYZ123...

    ; IMPORTANT: Replace with actual credentials
    ; This file will be mounted from a Secret in production
    "postgres" "md5placeholder"
