# ExternalSecrets for Auth Service
# Creates the secrets expected by the Helm chart

---
# PostgreSQL secret
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: velure-auth-postgres-es
  namespace: authentication
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: aws-secrets-manager
    kind: ClusterSecretStore
  target:
    name: velure-auth-postgres
    creationPolicy: Owner
  data:
    - secretKey: url
      remoteRef:
        key: velure/production/rds-auth
        property: url

---
# JWT secret (only fetching existing keys from AWS)
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: velure-auth-jwt-es
  namespace: authentication
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: aws-secrets-manager
    kind: ClusterSecretStore
  target:
    name: velure-auth-jwt
    creationPolicy: Owner
    template:
      data:
        secret: "{{ .secret }}"
        refreshSecret: "{{ .refreshSecret }}"
        expiresIn: "24h"
        refreshExpiresIn: "168h"
  data:
    - secretKey: secret
      remoteRef:
        key: velure/production/jwt
        property: secret
    - secretKey: refreshSecret
      remoteRef:
        key: velure/production/jwt
        property: refreshSecret

---
# Session secret (using JWT secret for session as well)
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: velure-auth-session-es
  namespace: authentication
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: aws-secrets-manager
    kind: ClusterSecretStore
  target:
    name: velure-auth-session
    creationPolicy: Owner
    template:
      data:
        secret: "{{ .secret }}"
        expiresIn: "24h"
  data:
    - secretKey: secret
      remoteRef:
        key: velure/production/jwt
        property: secret
