name: CI/CD Pipeline

on:
  push:
    branches:
      - master
  pull_request:
    branches:
      - master

jobs:
  determine-changes:
    runs-on: ubuntu-latest
    outputs:
      auth-service: ${{ steps.filter.outputs.auth-service }}
      product-service: ${{ steps.filter.outputs.product-service }}
      ui-service: ${{ steps.filter.outputs.ui-service }}
      publish-order-service: ${{ steps.filter.outputs.publish-order-service }}
      process-order-service: ${{ steps.filter.outputs.process-order-service }}
      infrastructure: ${{ steps.filter.outputs.infrastructure }}
      shared: ${{ steps.filter.outputs.shared }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Determine changed services
        id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            auth-service:
              - 'services/auth-service/**'
            product-service:
              - 'services/product-service/**'
            ui-service:
              - 'services/ui-service/**'
            publish-order-service:
              - 'services/publish-order-service/**'
            process-order-service:
              - 'services/process-order-service/**'
            infrastructure:
              - 'infrastructure/**'
            shared:
              - 'shared/**'

  auth-service:
    needs: determine-changes
    if: needs.determine-changes.outputs.auth-service == 'true' || needs.determine-changes.outputs.shared == 'true'
    uses: ./.github/workflows/go-service.yml
    with:
      service-name: auth
      service-path: services/auth-service
    secrets:
      DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
      DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}

  product-service:
    needs: determine-changes
    if: needs.determine-changes.outputs.product-service == 'true' || needs.determine-changes.outputs.shared == 'true'
    uses: ./.github/workflows/go-service.yml
    with:
      service-name: product
      service-path: services/product-service
    secrets:
      DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
      DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}

  ui-service:
    needs: determine-changes
    if: needs.determine-changes.outputs.ui-service == 'true'
    uses: ./.github/workflows/node-service.yml
    with:
      service-name: ui
      service-path: services/ui-service
    secrets:
      DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
      DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}

  publish-order-service:
    needs: determine-changes
    if: needs.determine-changes.outputs.publish-order-service == 'true' || needs.determine-changes.outputs.shared == 'true'
    uses: ./.github/workflows/go-service.yml
    with:
      service-name: publish-order
      service-path: services/publish-order-service
    secrets:
      DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
      DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}

  process-order-service:
    needs: determine-changes
    if: needs.determine-changes.outputs.process-order-service == 'true' || needs.determine-changes.outputs.shared == 'true'
    uses: ./.github/workflows/go-service.yml
    with:
      service-name: process-order
      service-path: services/process-order-service
    secrets:
      DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
      DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}

